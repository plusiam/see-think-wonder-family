<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ê°€ì¡±ê³¼ í•¨ê»˜í•˜ëŠ” ë§ˆìŒì˜ ì—¬í–‰ - ìš°ë¦¬ ê°€ì¡± ë§ˆìŒ íƒí—˜ëŒ€">
    <meta name="keywords" content="ê°€ì¡±, ê°ì •, êµìœ¡, ìƒë‹´">
    <meta property="og:title" content="ìš°ë¦¬ ê°€ì¡± ë§ˆìŒ íƒí—˜ëŒ€">
    <meta property="og:description" content="ê°€ì¡± ì‚¬ì§„ì„ ë³´ë©° ê°ì •ê³¼ ìƒê°ì„ íƒìƒ‰í•˜ëŠ” êµìœ¡ ë„êµ¬">
    <meta property="og:type" content="website">
    <title>ìš°ë¦¬ ê°€ì¡± ë§ˆìŒ íƒí—˜ëŒ€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }

        .gradient-bg {
            background: linear-gradient(135deg, #dbeafe 0%, #faf5ff 50%, #fce7f3 100%);
        }

        .progress-gradient {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
        }

        /* í°íŠ¸ ìµœì í™” */
        body, * {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* í•œê¸€ í…ìŠ¤íŠ¸ ìµœì í™” */
        .korean-text {
            word-break: keep-all;
            line-height: 1.7;
            letter-spacing: -0.02em;
        }

        /* ê²°ê³¼ í™”ë©´ ì „ìš© ìŠ¤íƒ€ì¼ */
        #resultDiv {
            font-size: 15px !important;
            line-height: 1.7 !important;
        }

        #resultDiv * {
            word-break: keep-all !important;
            overflow-wrap: break-word !important;
            hyphens: none !important;
        }

        #resultDiv p {
            margin: 0 !important;
            padding: 0 !important;
            white-space: pre-wrap !important;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ê°œì„  */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ì´ë¯¸ì§€ ë“œë˜ê·¸ ë°©ì§€ */
        img {
            user-select: none;
            -webkit-user-drag: none;
        }

        /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ (ê²°ê³¼ ì˜ì—­ ì œì™¸) */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* ê³ í•´ìƒë„ ë””ìŠ¤í”Œë ˆì´ ìµœì í™” */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            #resultDiv {
                font-size: 16px !important;
            }
        }

        /* ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes celebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .celebrate {
            animation: celebration 0.6s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800 mb-2">ìš°ë¦¬ ê°€ì¡± ë§ˆìŒ íƒí—˜ëŒ€</h1>
            <p class="text-gray-600">ê°€ì¡±ê³¼ í•¨ê»˜í•˜ëŠ” ë§ˆìŒì˜ ì—¬í–‰</p>
        </header>

        <!-- Progress Bar -->
        <div class="bg-white rounded-lg p-4 mb-6 shadow-md no-print">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-600">ì§„í–‰ ìƒí™©</span>
                    <button id="resetBtn" class="p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" title="ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ê¸°" aria-label="ë‹¤ì‹œ ì‹œì‘">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <button id="saveBtn" class="p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 rounded transition-colors" title="ì§„í–‰ ìƒí™© ì €ì¥" aria-label="ì €ì¥">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </button>
                </div>
                <span id="progressText" class="text-sm font-medium text-gray-600">1/9</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="progress-gradient h-3 rounded-full transition-all duration-300" style="width: 11.11%"></div>
            </div>
            <div class="text-center mt-2">
                <span id="stepTitle" class="text-lg font-medium text-gray-700">ì‹œì‘í•˜ê¸°</span>
            </div>
        </div>

        <!-- Main Content -->
        <main class="bg-white rounded-xl p-6 md:p-8 shadow-lg min-h-[400px]">
            <div id="stepContent" class="fade-in">
                <!-- ë™ì  ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
            </div>
        </main>

        <!-- Navigation -->
        <nav class="flex justify-between mt-6 no-print" role="navigation">
            <button id="prevBtn" class="flex items-center px-4 md:px-6 py-3 rounded-xl font-medium transition-colors bg-gray-200 text-gray-400 cursor-not-allowed" aria-label="ì´ì „ ë‹¨ê³„">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="hidden sm:inline">ì´ì „</span>
            </button>

            <button id="nextBtn" class="flex items-center px-4 md:px-6 py-3 rounded-xl font-medium transition-colors bg-gray-200 text-gray-400 cursor-not-allowed" aria-label="ë‹¤ìŒ ë‹¨ê³„">
                <span class="hidden sm:inline">ë‹¤ìŒ</span>
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </nav>

        <!-- Helpful message -->
        <div id="helpMessage" class="text-center mt-4 hidden">
            <p class="text-orange-600 bg-orange-50 px-4 py-2 rounded-lg inline-block">
                ğŸ“ ëª¨ë“  ë‚´ìš©ì„ ì‘ì„±í•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ê°ˆ ìˆ˜ ìˆì–´ìš”
            </p>
        </div>

        <!-- Auto-save indicator -->
        <div id="saveIndicator" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg hidden">
            âœ“ ìë™ ì €ì¥ë¨
        </div>

        <!-- Debug info (ê°œë°œìš©) -->
        <div id="debugInfo" class="fixed bottom-4 left-4 bg-gray-800 text-white text-xs p-2 rounded hidden">
            <div>ë‹¨ê³„: <span id="debugStep">0</span></div>
            <div>ì§„í–‰ ê°€ëŠ¥: <span id="debugCanProceed">false</span></div>
            <div>í˜„ì¬ ê°’: <span id="debugValue">""</span></div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;">

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-700">ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ ê´€ë¦¬
        const appState = {
            currentStep: 0,
            studentName: '',
            familyImage: null,
            seeAnswers: '',
            thinkAnswers: '',
            wonderAnswers: '',
            emotions: [],
            myStory: '',
            reflection: '',
            lastSaved: null
        };

        const steps = [
            'ì‹œì‘í•˜ê¸°',
            'ê°€ì¡± ì‚¬ì§„',
            'See ë³´ê¸°',
            'Think ìƒê°í•˜ê¸°',
            'Wonder ê¶ê¸ˆí•˜ê¸°',
            'ê°ì • í‘œí˜„í•˜ê¸°',
            'ë‚˜ì˜ ì´ì•¼ê¸°',
            'ì„±ì°°í•˜ê¸°',
            'ì™„ì„±!'
        ];

        const emotionOptions = [
            { emoji: 'ğŸ˜Š', name: 'í–‰ë³µí•´ìš”', color: 'bg-yellow-200' },
            { emoji: 'ğŸ˜¢', name: 'ìŠ¬í¼ìš”', color: 'bg-blue-200' },
            { emoji: 'ğŸ˜ ', name: 'í™”ë‚˜ìš”', color: 'bg-red-200' },
            { emoji: 'ğŸ˜°', name: 'ê±±ì •ë¼ìš”', color: 'bg-gray-200' },
            { emoji: 'ğŸ¥°', name: 'ì‚¬ë‘í•´ìš”', color: 'bg-pink-200' },
            { emoji: 'ğŸ˜´', name: 'í¸ì•ˆí•´ìš”', color: 'bg-green-200' },
            { emoji: 'ğŸ˜¤', name: 'ë‹µë‹µí•´ìš”', color: 'bg-orange-200' },
            { emoji: 'ğŸ¤—', name: 'ë”°ëœ»í•´ìš”', color: 'bg-purple-200' }
        ];

        // DOM ìš”ì†Œë“¤
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const stepTitle = document.getElementById('stepTitle');
        const stepContent = document.getElementById('stepContent');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const helpMessage = document.getElementById('helpMessage');
        const resetBtn = document.getElementById('resetBtn');
        const saveBtn = document.getElementById('saveBtn');
        const fileInput = document.getElementById('fileInput');
        const saveIndicator = document.getElementById('saveIndicator');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // ë””ë²„ê·¸ ìš”ì†Œë“¤ (ê°œë°œìš©)
        const debugInfo = document.getElementById('debugInfo');
        const debugStep = document.getElementById('debugStep');
        const debugCanProceed = document.getElementById('debugCanProceed');
        const debugValue = document.getElementById('debugValue');

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEY = 'familyEmotionExplorer';

        // ë””ë²„ê·¸ ëª¨ë“œ (ê°œë°œìš© - ì‹¤ì œ ë°°í¬ì‹œì—ëŠ” falseë¡œ ì„¤ì •)
        const DEBUG_MODE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // ì´ˆê¸°í™”
        function init() {
            loadFromLocalStorage();
            updateUI();
            renderStep();

            // ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
            if (DEBUG_MODE) {
                debugInfo.classList.remove('hidden');
                console.log('ğŸ› Debug mode activated');
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            prevBtn.addEventListener('click', prevStep);
            nextBtn.addEventListener('click', nextStep);
            resetBtn.addEventListener('click', resetAll);
            saveBtn.addEventListener('click', saveToLocalStorage);
            fileInput.addEventListener('change', handleImageUpload);

            // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
            document.addEventListener('keydown', handleKeyboard);

            // ìë™ ì €ì¥
            setInterval(autoSave, 30000); // 30ì´ˆë§ˆë‹¤ ìë™ ì €ì¥
        }

        // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateDebugInfo() {
            if (DEBUG_MODE) {
                debugStep.textContent = appState.currentStep;
                debugCanProceed.textContent = canProceed();
                
                let currentValue = '';
                switch (appState.currentStep) {
                    case 0: currentValue = appState.studentName; break;
                    case 1: currentValue = appState.familyImage ? 'uploaded' : 'not uploaded'; break;
                    case 2: currentValue = appState.seeAnswers; break;
                    case 3: currentValue = appState.thinkAnswers; break;
                    case 4: currentValue = appState.wonderAnswers; break;
                    case 5: currentValue = appState.emotions.length + ' emotions'; break;
                    case 6: currentValue = appState.myStory; break;
                    case 7: currentValue = appState.reflection; break;
                    default: currentValue = 'completed';
                }
                debugValue.textContent = `"${currentValue}"`;
            }
        }

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        function handleKeyboard(e) {
            if (e.altKey) {
                if (e.key === 'ArrowLeft' && !prevBtn.disabled) {
                    prevStep();
                } else if (e.key === 'ArrowRight' && !nextBtn.disabled) {
                    nextStep();
                }
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(appState, data);
                }
            } catch (error) {
                console.error('Failed to load saved data:', error);
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        function saveToLocalStorage() {
            try {
                appState.lastSaved = new Date().toISOString();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                showSaveIndicator();
            } catch (error) {
                console.error('Failed to save data:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìë™ ì €ì¥
        function autoSave() {
            if (appState.studentName || appState.currentStep > 0) {
                saveToLocalStorage();
            }
        }

        // ì €ì¥ í‘œì‹œ
        function showSaveIndicator() {
            saveIndicator.classList.remove('hidden');
            setTimeout(() => {
                saveIndicator.classList.add('hidden');
            }, 2000);
        }

        // ë¡œë”© í‘œì‹œ (ê°œì„ ëœ ë©”ì‹œì§€)
        function showLoading(show = true, message = 'ì²˜ë¦¬ ì¤‘...') {
            const loadingText = document.querySelector('#loadingOverlay p');
            if (show) {
                if (loadingText) loadingText.textContent = message;
                loadingOverlay.classList.remove('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
            }
        }

        // UI ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
        function updateUI() {
            const progress = ((appState.currentStep + 1) / steps.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${appState.currentStep + 1}/${steps.length}`;
            stepTitle.textContent = steps[appState.currentStep];

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            prevBtn.disabled = appState.currentStep === 0;
            prevBtn.className = appState.currentStep === 0
                ? "flex items-center px-4 md:px-6 py-3 rounded-xl font-medium transition-colors bg-gray-200 text-gray-400 cursor-not-allowed"
                : "flex items-center px-4 md:px-6 py-3 rounded-xl font-medium transition-colors bg-gray-500 text-white hover:bg-gray-600";

            const canProceedValue = canProceed();
            nextBtn.disabled = appState.currentStep === steps.length - 1 || !canProceedValue;
            nextBtn.className = appState.currentStep === steps.length - 1 || !canProceedValue
                ? "flex items-center px-4 md:px-6 py-3 rounded-xl font-medium transition-colors bg-gray-200 text-gray-400 cursor-not-allowed"
                : "flex items-center px-4 md:px-6 py-3 rounded-xl font-medium transition-colors bg-blue-500 text-white hover:bg-blue-600";

            // ë„ì›€ë§ ë©”ì‹œì§€
            helpMessage.className = !canProceedValue && appState.currentStep < steps.length - 1
                ? "text-center mt-4"
                : "text-center mt-4 hidden";

            // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
            updateDebugInfo();

            // ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê·¸ ëª¨ë“œì—ì„œë§Œ)
            if (DEBUG_MODE) {
                console.log(`ğŸ”„ UI Updated - Step: ${appState.currentStep}, Can proceed: ${canProceedValue}`);
            }
        }

        // ì§„í–‰ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        function canProceed() {
            switch (appState.currentStep) {
                case 0: return appState.studentName.trim() !== '';
                case 1: return appState.familyImage !== null;
                case 2: return appState.seeAnswers.trim() !== '';
                case 3: return appState.thinkAnswers.trim() !== '';
                case 4: return appState.wonderAnswers.trim() !== '';
                case 5: return appState.emotions.length > 0;
                case 6: return appState.myStory.trim() !== '';
                case 7: return appState.reflection.trim() !== '';
                default: return true;
            }
        }

        // ìƒˆë¡œìš´ íƒí—˜ ì‹œì‘ í•¨ìˆ˜
        function startNewExploration() {
            if (confirm('ìƒˆë¡œìš´ ê°€ì¡± ë§ˆìŒ íƒí—˜ì„ ì‹œì‘í•˜ì‹œê² ì–´ìš”?\n\ní˜„ì¬ ê²°ê³¼ëŠ” ì €ì¥í•˜ê³  ìƒˆë¡œìš´ íƒí—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.')) {
                // í˜„ì¬ ê²°ê³¼ ë°±ì—…
                const backup = JSON.stringify({
                    ...appState,
                    timestamp: new Date().toISOString(),
                    backupReason: 'new_exploration'
                });
                
                try {
                    localStorage.setItem(`${STORAGE_KEY}_backup_${Date.now()}`, backup);
                } catch (error) {
                    console.warn('ë°±ì—… ì €ì¥ ì‹¤íŒ¨:', error);
                }
                
                // ìƒíƒœ ì´ˆê¸°í™”
                Object.assign(appState, {
                    currentStep: 0,
                    studentName: '',
                    familyImage: null,
                    seeAnswers: '',
                    thinkAnswers: '',
                    wonderAnswers: '',
                    emotions: [],
                    myStory: '',
                    reflection: '',
                    lastSaved: null
                });
                
                localStorage.removeItem(STORAGE_KEY);
                updateUI();
                renderStep();
                
                // ì„±ê³µ ë©”ì‹œì§€
                setTimeout(() => {
                    alert('ğŸš€ ìƒˆë¡œìš´ ê°€ì¡± ë§ˆìŒ íƒí—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤!\n\nì´ì „ ê²°ê³¼ëŠ” ì•ˆì „í•˜ê²Œ ë°±ì—…ë˜ì—ˆì–´ìš”.');
                }, 500);
                
                if (DEBUG_MODE) {
                    console.log('ğŸ†• Started new exploration');
                }
            }
        }

        // ë‹¨ê³„ë³„ ë Œë”ë§ (ê°œì„ ëœ ì• ë‹ˆë©”ì´ì…˜)
        function renderStep() {
            // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±° í›„ ì¬ì ìš©
            stepContent.classList.remove('fade-in');
            
            let content = '';

            switch (appState.currentStep) {
                case 0:
                    content = `
                        <div class="text-center space-y-6">
                            <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                            <h2 class="text-2xl md:text-3xl font-bold text-blue-600 mb-4">ìš°ë¦¬ ê°€ì¡± ë§ˆìŒ íƒí—˜ëŒ€</h2>
                            <p class="text-base md:text-lg text-gray-700 mb-6">ê°€ì¡±ê³¼ í•¨ê»˜í•˜ëŠ” ë§ˆìŒì˜ ì—¬í–‰ì„ ë– ë‚˜ë³¼ê¹Œìš”?</p>
                            <input
                                type="text"
                                id="studentNameInput"
                                placeholder="ë‚´ ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”"
                                value="${appState.studentName}"
                                class="w-full max-w-md mx-auto p-4 text-lg md:text-xl border-2 border-blue-300 rounded-xl focus:border-blue-500 outline-none"
                                aria-label="í•™ìƒ ì´ë¦„"
                                autocomplete="name"
                            />
                            ${appState.lastSaved ? `
                                <p class="text-sm text-gray-500 mt-4">
                                    ë§ˆì§€ë§‰ ì €ì¥: ${new Date(appState.lastSaved).toLocaleString('ko-KR')}
                                </p>
                            ` : ''}
                        </div>
                    `;
                    break;

                case 1:
                    content = `
                        <div class="text-center space-y-6">
                            <h2 class="text-xl md:text-2xl font-bold text-blue-600 mb-4">
                                ğŸ“· ìš°ë¦¬ ê°€ì¡± ì‚¬ì§„ì„ ë³´ì—¬ì£¼ì„¸ìš”
                            </h2>
                            ${!appState.familyImage ? `
                                <div id="uploadArea" class="w-full max-w-md mx-auto h-64 border-4 border-dashed border-blue-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 transition-colors">
                                    <div class="text-5xl text-blue-400 mb-2">ğŸ“¤</div>
                                    <p class="text-lg text-blue-600">ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                                    <p class="text-sm text-gray-500">ë˜ëŠ” ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                                    <p class="text-xs text-gray-400 mt-2">ë“œë˜ê·¸ ì•¤ ë“œë¡­ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    <img src="${appState.familyImage}" alt="ê°€ì¡± ì‚¬ì§„" class="w-full max-w-md mx-auto rounded-xl shadow-lg">
                                    <button id="changeImageBtn" class="px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
                                        ë‹¤ë¥¸ ì‚¬ì§„ ì„ íƒí•˜ê¸°
                                    </button>
                                </div>
                            `}
                            <p class="text-sm text-gray-500">
                                ì§€ì› í˜•ì‹: JPG, PNG, GIF (ìµœëŒ€ 10MB)
                            </p>
                        </div>
                    `;
                    break;

                case 2:
                    content = `
                        <div class="space-y-6">
                            <h2 class="text-xl md:text-2xl font-bold text-green-600 text-center mb-4">
                                ğŸ‘€ SEE - ë¬´ì—‡ì´ ë³´ì´ë‚˜ìš”?
                            </h2>
                            ${appState.familyImage ? `
                                <img src="${appState.familyImage}" alt="ê°€ì¡± ì‚¬ì§„" class="w-full max-w-sm mx-auto rounded-xl shadow-lg mb-4">
                            ` : ''}
                            <div class="bg-green-50 p-4 rounded-xl">
                                <p class="text-base md:text-lg mb-3 text-green-700">ì‚¬ì§„ì—ì„œ ë³´ì´ëŠ” ê²ƒë“¤ì„ ì ì–´ì£¼ì„¸ìš”:</p>
                                <textarea
                                    id="seeAnswersInput"
                                    placeholder="ì˜ˆ: ì—„ë§ˆ, ì•„ë¹ , ë‚˜, ë™ìƒì´ ë³´ì—¬ìš”. ëª¨ë‘ ì›ƒê³  ìˆì–´ìš”."
                                    class="w-full h-32 p-3 border-2 border-green-200 rounded-lg focus:border-green-400 outline-none resize-none text-base md:text-lg"
                                    aria-label="ë³´ì´ëŠ” ê²ƒ ì„¤ëª…"
                                >${appState.seeAnswers}</textarea>
                                <p class="text-sm text-gray-500 mt-2">
                                    íŒ: ì‚¬ëŒ, í‘œì •, ë°°ê²½, ì˜·ì°¨ë¦¼ ë“±ì„ ìì„¸íˆ ê´€ì°°í•´ë³´ì„¸ìš”
                                </p>
                            </div>
                        </div>
                    `;
                    break;

                case 3:
                    content = `
                        <div class="space-y-6">
                            <h2 class="text-xl md:text-2xl font-bold text-orange-600 text-center mb-4">
                                ğŸ¤” THINK - ì–´ë–¤ ìƒê°ì´ ë“œë‚˜ìš”?
                            </h2>
                            ${appState.familyImage ? `
                                <img src="${appState.familyImage}" alt="ê°€ì¡± ì‚¬ì§„" class="w-full max-w-sm mx-auto rounded-xl shadow-lg mb-4">
                            ` : ''}
                            <div class="bg-orange-50 p-4 rounded-xl">
                                <p class="text-base md:text-lg mb-3 text-orange-700">ì´ ì‚¬ì§„ì„ ë³´ë©° ë“œëŠ” ìƒê°ì„ ì ì–´ì£¼ì„¸ìš”:</p>
                                <textarea
                                    id="thinkAnswersInput"
                                    placeholder="ì˜ˆ: ìš°ë¦¬ ê°€ì¡±ì´ í–‰ë³µí•´ ë³´ì—¬ìš”. í•¨ê»˜ ìˆì–´ì„œ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”."
                                    class="w-full h-32 p-3 border-2 border-orange-200 rounded-lg focus:border-orange-400 outline-none resize-none text-base md:text-lg"
                                    aria-label="ìƒê° ì„¤ëª…"
                                >${appState.thinkAnswers}</textarea>
                                <p class="text-sm text-gray-500 mt-2">
                                    íŒ: ì´ ìˆœê°„ì˜ ë¶„ìœ„ê¸°ë‚˜ ëŠë‚Œì„ ë– ì˜¬ë ¤ë³´ì„¸ìš”
                                </p>
                            </div>
                        </div>
                    `;
                    break;

                case 4:
                    content = `
                        <div class="space-y-6">
                            <h2 class="text-xl md:text-2xl font-bold text-purple-600 text-center mb-4">
                                â“ WONDER - ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€ìš”?
                            </h2>
                            ${appState.familyImage ? `
                                <img src="${appState.familyImage}" alt="ê°€ì¡± ì‚¬ì§„" class="w-full max-w-sm mx-auto rounded-xl shadow-lg mb-4">
                            ` : ''}
                            <div class="bg-purple-50 p-4 rounded-xl">
                                <p class="text-base md:text-lg mb-3 text-purple-700">ì´ ì‚¬ì§„ì„ ë³´ë©° ê¶ê¸ˆí•œ ê²ƒì„ ì ì–´ì£¼ì„¸ìš”:</p>
                                <textarea
                                    id="wonderAnswersInput"
                                    placeholder="ì˜ˆ: ì´ë•Œ ìš°ë¦¬ê°€ ë­˜ í•˜ê³  ìˆì—ˆì„ê¹Œ? ë‹¤ë¥¸ ê°€ì¡±ë“¤ì€ ì–´ë–¨ê¹Œ?"
                                    class="w-full h-32 p-3 border-2 border-purple-200 rounded-lg focus:border-purple-400 outline-none resize-none text-base md:text-lg"
                                    aria-label="ê¶ê¸ˆí•œ ì "
                                >${appState.wonderAnswers}</textarea>
                                <p class="text-sm text-gray-500 mt-2">
                                    íŒ: ì‚¬ì§„ ì† ìƒí™©ì´ë‚˜ ê°€ì¡±ë“¤ì˜ ë§ˆìŒì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ìƒê°í•´ë³´ì„¸ìš”
                                </p>
                            </div>
                        </div>
                    `;
                    break;

                case 5:
                    content = `
                        <div class="space-y-6">
                            <h2 class="text-xl md:text-2xl font-bold text-pink-600 text-center mb-4">
                                ğŸ’ ê°€ì¡±ê³¼ í•¨ê»˜ ìˆì„ ë•Œ ì–´ë–¤ ê¸°ë¶„ì¸ê°€ìš”?
                            </h2>
                            <p class="text-center text-gray-600">ëŠë¼ëŠ” ê°ì •ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš” (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-2xl mx-auto">
                                ${emotionOptions.map((emotion, index) => {
                                    const isSelected = appState.emotions.find(e => e.name === emotion.name);
                                    return `
                                        <button
                                            data-emotion='${JSON.stringify(emotion)}'
                                            class="emotion-btn p-3 md:p-4 rounded-xl border-2 transition-all ${
                                                isSelected
                                                    ? `${emotion.color} border-pink-400 scale-105`
                                                    : 'bg-white border-gray-200 hover:border-pink-200'
                                            }"
                                            aria-pressed="${isSelected ? 'true' : 'false'}"
                                            aria-label="ê°ì • ì„ íƒ: ${emotion.name}"
                                        >
                                            <div class="text-2xl md:text-3xl mb-2">${emotion.emoji}</div>
                                            <div class="text-sm font-medium">${emotion.name}</div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                            ${appState.emotions.length > 0 ? `
                                <div class="text-center mt-4">
                                    <p class="text-pink-600 font-medium">ì„ íƒí•œ ê°ì •:</p>
                                    <div class="flex flex-wrap justify-center gap-2 mt-2">
                                        ${appState.emotions.map(emotion => `
                                            <span class="px-3 py-1 rounded-full ${emotion.color} text-sm">
                                                ${emotion.emoji} ${emotion.name}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    break;

                case 6:
                    content = `
                        <div class="space-y-6">
                            <h2 class="text-xl md:text-2xl font-bold text-indigo-600 text-center mb-4">
                                ğŸ‘¥ ê°€ì¡± ì†ì—ì„œ ë‚˜ëŠ” ëˆ„êµ¬ì¼ê¹Œìš”?
                            </h2>
                            <div class="bg-indigo-50 p-4 rounded-xl">
                                <p class="text-base md:text-lg mb-3 text-indigo-700">ìš°ë¦¬ ê°€ì¡±ì—ì„œ ë‚˜ëŠ” ì–´ë–¤ ì‚¬ëŒì¸ì§€ ì†Œê°œí•´ì£¼ì„¸ìš”:</p>
                                <textarea
                                    id="myStoryInput"
                                    placeholder="ì˜ˆ: ë‚˜ëŠ” ìš°ë¦¬ ê°€ì¡±ì˜ ë§‰ë‚´ì˜ˆìš”. ê°€ì¡±ë“¤ì„ ì›ƒê²Œ ë§Œë“œëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”. ê°€ì¡±ê³¼ í•¨ê»˜ ìˆì„ ë•Œ ê°€ì¥ í–‰ë³µí•´ìš”."
                                    class="w-full h-40 p-3 border-2 border-indigo-200 rounded-lg focus:border-indigo-400 outline-none resize-none text-base md:text-lg"
                                    aria-label="ë‚˜ì˜ ì´ì•¼ê¸°"
                                >${appState.myStory}</textarea>
                                <p class="text-sm text-gray-500 mt-2">
                                    íŒ: ê°€ì¡± ì•ˆì—ì„œì˜ ë‚˜ì˜ ì—­í• , íŠ¹ë³„í•œ ì , ì¢‹ì•„í•˜ëŠ” ê²ƒë“¤ì„ ìƒê°í•´ë³´ì„¸ìš”
                                </p>
                            </div>
                        </div>
                    `;
                    break;

                case 7:
                    content = `
                        <div class="space-y-6">
                            <h2 class="text-xl md:text-2xl font-bold text-emerald-600 text-center mb-4">
                                â­ ì˜¤ëŠ˜ ë°°ìš´ ê²ƒì„ ìƒê°í•´ë³¼ê¹Œìš”?
                            </h2>
                            <div class="bg-emerald-50 p-4 rounded-xl">
                                <p class="text-base md:text-lg mb-3 text-emerald-700">
                                    "ê°€ì¡± ê´€ê³„ì—ì„œ ë‚˜ëŠ” ì–´ë–¤ ëª¨ìŠµì¼ê¹Œ?"ë¥¼ ìƒê°í•˜ë©° ì˜¤ëŠ˜ ëŠë‚€ ì ì„ ì ì–´ì£¼ì„¸ìš”:
                                </p>
                                <textarea
                                    id="reflectionInput"
                                    placeholder="ì˜ˆ: ê°€ì¡±ê³¼ í•¨ê»˜ ìˆì„ ë•Œ ë‚´ê°€ ì–¼ë§ˆë‚˜ íŠ¹ë³„í•œ ì‚¬ëŒì¸ì§€ ì•Œê²Œ ë˜ì—ˆì–´ìš”."
                                    class="w-full h-32 p-3 border-2 border-emerald-200 rounded-lg focus:border-emerald-400 outline-none resize-none text-base md:text-lg"
                                    aria-label="ì„±ì°° ë‚´ìš©"
                                >${appState.reflection}</textarea>
                                <p class="text-sm text-gray-500 mt-2">
                                    íŒ: ì˜¤ëŠ˜ ë°œê²¬í•œ ìƒˆë¡œìš´ ì ì´ë‚˜ ê°ì‚¬í•œ ë§ˆìŒì„ í‘œí˜„í•´ë³´ì„¸ìš”
                                </p>
                            </div>
                        </div>
                    `;
                    break;

                case 8:
                    content = `
                        <div class="text-center space-y-6">
                            <div class="text-6xl mb-4 celebrate">ğŸ‰</div>
                            <h2 class="text-2xl md:text-3xl font-bold text-blue-600 mb-4">ì™„ì„±ë˜ì—ˆì–´ìš”!</h2>
                            <div id="resultDiv" class="bg-blue-50 p-6 rounded-xl max-w-3xl mx-auto text-left" style="min-height: auto; font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif; line-height: 1.6;">
                                <h3 class="text-xl font-bold text-blue-800 text-center mb-6" style="word-break: keep-all;">${appState.studentName}ë‹˜ì˜ ê°€ì¡± ë§ˆìŒ íƒí—˜ ê²°ê³¼</h3>
                                
                                ${appState.familyImage ? `
                                    <div class="mb-6 text-center">
                                        <img src="${appState.familyImage}" alt="ê°€ì¡± ì‚¬ì§„" class="max-w-xs mx-auto rounded-lg shadow-md" style="max-height: 200px; object-fit: contain;">
                                    </div>
                                ` : ''}
                                
                                <div class="space-y-5">
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-bold text-green-700 mb-3 text-lg" style="word-break: keep-all;">ğŸ‘€ ë³´ì¸ ê²ƒ:</h4>
                                        <p class="text-gray-800 leading-relaxed" style="word-break: keep-all; white-space: pre-wrap; font-size: 15px;">${appState.seeAnswers}</p>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-bold text-orange-700 mb-3 text-lg" style="word-break: keep-all;">ğŸ¤” ìƒê°í•œ ê²ƒ:</h4>
                                        <p class="text-gray-800 leading-relaxed" style="word-break: keep-all; white-space: pre-wrap; font-size: 15px;">${appState.thinkAnswers}</p>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-bold text-purple-700 mb-3 text-lg" style="word-break: keep-all;">â“ ê¶ê¸ˆí•œ ê²ƒ:</h4>
                                        <p class="text-gray-800 leading-relaxed" style="word-break: keep-all; white-space: pre-wrap; font-size: 15px;">${appState.wonderAnswers}</p>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-bold text-pink-700 mb-3 text-lg" style="word-break: keep-all;">ğŸ’ ëŠë‚€ ê°ì •:</h4>
                                        <div class="flex flex-wrap gap-2">
                                            ${appState.emotions.map(emotion => `
                                                <span class="px-3 py-2 rounded-full ${emotion.color} text-sm font-medium" style="white-space: nowrap; word-break: keep-all;">
                                                    ${emotion.emoji} ${emotion.name}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-bold text-indigo-700 mb-3 text-lg" style="word-break: keep-all;">ğŸ‘¥ ë‚˜ì˜ ì´ì•¼ê¸°:</h4>
                                        <p class="text-gray-800 leading-relaxed" style="word-break: keep-all; white-space: pre-wrap; font-size: 15px;">${appState.myStory}</p>
                                    </div>
                                    
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <h4 class="font-bold text-emerald-700 mb-3 text-lg" style="word-break: keep-all;">â­ ì˜¤ëŠ˜ì˜ ê¹¨ë‹¬ìŒ:</h4>
                                        <p class="text-gray-800 leading-relaxed" style="word-break: keep-all; white-space: pre-wrap; font-size: 15px;">${appState.reflection}</p>
                                    </div>
                                </div>
                                
                                <div class="mt-6 pt-4 border-t border-blue-200 text-center">
                                    <p class="text-sm text-blue-600" style="font-size: 13px;">ğŸ“… ${new Date().toLocaleDateString('ko-KR')} ìƒì„±</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4 no-print">
                                <!-- ê²°ê³¼ ê´€ë ¨ ë²„íŠ¼ë“¤ -->
                                <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
                                    <button id="downloadBtn" class="px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors font-medium flex items-center gap-2">
                                        ğŸ“¥ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°
                                    </button>
                                    <button id="printBtn" class="px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors font-medium">
                                        ğŸ–¨ï¸ ê²°ê³¼ ì¸ì‡„í•˜ê¸°
                                    </button>
                                    <button id="shareBtn" class="px-6 py-3 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-colors font-medium">
                                        ğŸ“¤ ê³µìœ í•˜ê¸°
                                    </button>
                                </div>
                                
                                <!-- êµ¬ë¶„ì„  -->
                                <div class="flex items-center my-6">
                                    <div class="flex-1 border-t border-gray-300"></div>
                                    <span class="px-4 text-gray-500 text-sm">ë‹¤ìŒ ë‹¨ê³„</span>
                                    <div class="flex-1 border-t border-gray-300"></div>
                                </div>
                                
                                <!-- ìƒˆë¡œìš´ íƒí—˜ ê´€ë ¨ ë²„íŠ¼ë“¤ -->
                                <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
                                    <button id="newExplorationBtn" class="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 transition-colors font-bold flex items-center gap-2 text-lg">
                                        ğŸš€ ìƒˆë¡œìš´ íƒí—˜ ì‹œì‘í•˜ê¸°
                                    </button>
                                    <button id="resetAllBtn" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors font-medium flex items-center gap-2">
                                        ğŸ”„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘
                                    </button>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <p class="text-sm text-gray-600">ğŸ’¡ <strong>ìƒˆë¡œìš´ íƒí—˜</strong>ì€ í˜„ì¬ ê²°ê³¼ë¥¼ ë°±ì—…í•˜ê³  ìƒˆë¡œ ì‹œì‘í•˜ë©°,<br><strong>ë‹¤ì‹œ ì‹œì‘</strong>ì€ ëª¨ë“  ë‚´ìš©ì„ ì§€ìš°ê³  ì²˜ìŒë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            stepContent.innerHTML = content;
            
            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—° í›„ í´ë˜ìŠ¤ ì¶”ê°€
            setTimeout(() => {
                stepContent.classList.add('fade-in');
            }, 10);
            
            attachStepEventListeners();
        }

        // ê°œì„ ëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜
        function addMultipleEventListeners(element, events, handler) {
            events.forEach(event => {
                element.addEventListener(event, handler);
            });
        }

        // ë‹¨ê³„ë³„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ê°œì„ ëœ ë²„ì „)
        function attachStepEventListeners() {
            switch (appState.currentStep) {
                case 0:
                    const nameInput = document.getElementById('studentNameInput');
                    if (nameInput) {
                        // ì—¬ëŸ¬ ì´ë²¤íŠ¸ íƒ€ì…ìœ¼ë¡œ ì‹¤ì‹œê°„ ê°ì§€
                        addMultipleEventListeners(nameInput, ['input', 'paste', 'keyup'], (e) => {
                            // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ì…ë ¥ ì™„ë£Œ í›„ ì²˜ë¦¬
                            setTimeout(() => {
                                appState.studentName = e.target.value;
                                updateUI();
                                autoSave();
                                
                                if (DEBUG_MODE) {
                                    console.log(`ğŸ“ Name input: "${appState.studentName}"`);
                                }
                            }, 10);
                        });
                        nameInput.focus();
                    }
                    break;

                case 1:
                    const uploadArea = document.getElementById('uploadArea');
                    const changeImageBtn = document.getElementById('changeImageBtn');

                    if (uploadArea) {
                        uploadArea.addEventListener('click', () => fileInput.click());
                        uploadArea.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            uploadArea.classList.add('border-blue-500', 'bg-blue-50');
                        });
                        uploadArea.addEventListener('dragleave', () => {
                            uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                        });
                        uploadArea.addEventListener('drop', (e) => {
                            e.preventDefault();
                            uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                            const files = e.dataTransfer.files;
                            if (files.length > 0) {
                                handleImageFile(files[0]);
                            }
                        });
                    }

                    if (changeImageBtn) {
                        changeImageBtn.addEventListener('click', () => fileInput.click());
                    }
                    break;

                case 2:
                    const seeInput = document.getElementById('seeAnswersInput');
                    if (seeInput) {
                        addMultipleEventListeners(seeInput, ['input', 'paste', 'keyup'], (e) => {
                            setTimeout(() => {
                                appState.seeAnswers = e.target.value;
                                updateUI();
                                
                                if (DEBUG_MODE) {
                                    console.log(`ğŸ‘€ See input: "${appState.seeAnswers}"`);
                                }
                            }, 10);
                        });
                        seeInput.focus();
                    }
                    break;

                case 3:
                    const thinkInput = document.getElementById('thinkAnswersInput');
                    if (thinkInput) {
                        addMultipleEventListeners(thinkInput, ['input', 'paste', 'keyup'], (e) => {
                            setTimeout(() => {
                                appState.thinkAnswers = e.target.value;
                                updateUI();
                                
                                if (DEBUG_MODE) {
                                    console.log(`ğŸ¤” Think input: "${appState.thinkAnswers}"`);
                                }
                            }, 10);
                        });
                        thinkInput.focus();
                    }
                    break;

                case 4:
                    const wonderInput = document.getElementById('wonderAnswersInput');
                    if (wonderInput) {
                        addMultipleEventListeners(wonderInput, ['input', 'paste', 'keyup'], (e) => {
                            setTimeout(() => {
                                appState.wonderAnswers = e.target.value;
                                updateUI();
                                
                                if (DEBUG_MODE) {
                                    console.log(`â“ Wonder input: "${appState.wonderAnswers}"`);
                                }
                            }, 10);
                        });
                        wonderInput.focus();
                    }
                    break;

                case 5:
                    const emotionBtns = document.querySelectorAll('.emotion-btn');
                    emotionBtns.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const emotion = JSON.parse(btn.dataset.emotion);
                            toggleEmotion(emotion);
                            renderStep();
                            updateUI();
                            autoSave();
                            
                            if (DEBUG_MODE) {
                                console.log(`ğŸ’ Emotion toggled: ${emotion.name}, Total: ${appState.emotions.length}`);
                            }
                        });
                    });
                    break;

                case 6:
                    const storyInput = document.getElementById('myStoryInput');
                    if (storyInput) {
                        addMultipleEventListeners(storyInput, ['input', 'paste', 'keyup'], (e) => {
                            setTimeout(() => {
                                appState.myStory = e.target.value;
                                updateUI();
                                
                                if (DEBUG_MODE) {
                                    console.log(`ğŸ‘¥ Story input: "${appState.myStory}"`);
                                }
                            }, 10);
                        });
                        storyInput.focus();
                    }
                    break;

                case 7:
                    const reflectionInput = document.getElementById('reflectionInput');
                    if (reflectionInput) {
                        addMultipleEventListeners(reflectionInput, ['input', 'paste', 'keyup'], (e) => {
                            setTimeout(() => {
                                appState.reflection = e.target.value;
                                updateUI();
                                
                                if (DEBUG_MODE) {
                                    console.log(`â­ Reflection input: "${appState.reflection}"`);
                                }
                            }, 10);
                        });
                        reflectionInput.focus();
                    }
                    break;

                case 8:
                    const downloadBtn = document.getElementById('downloadBtn');
                    const printBtn = document.getElementById('printBtn');
                    const shareBtn = document.getElementById('shareBtn');
                    const newExplorationBtn = document.getElementById('newExplorationBtn');
                    const resetAllBtn = document.getElementById('resetAllBtn');

                    if (downloadBtn) {
                        downloadBtn.addEventListener('click', downloadAsImage);
                    }

                    if (printBtn) {
                        printBtn.addEventListener('click', () => window.print());
                    }

                    if (shareBtn) {
                        shareBtn.addEventListener('click', shareResult);
                    }

                    if (newExplorationBtn) {
                        newExplorationBtn.addEventListener('click', startNewExploration);
                    }

                    if (resetAllBtn) {
                        resetAllBtn.addEventListener('click', resetAll);
                    }
                    break;
            }
        }

        // ê°ì • í† ê¸€
        function toggleEmotion(emotion) {
            const existingIndex = appState.emotions.findIndex(e => e.name === emotion.name);
            if (existingIndex >= 0) {
                appState.emotions.splice(existingIndex, 1);
            } else {
                appState.emotions.push(emotion);
            }
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            showLoading();

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ (ìµœëŒ€ 800px)
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        appState.familyImage = canvas.toDataURL('image/jpeg', 0.8);
                        
                        // ë©”ëª¨ë¦¬ ì •ë¦¬
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        canvas.width = canvas.height = 0;
                        
                        showLoading(false);
                        renderStep();
                        updateUI();
                        autoSave();
                        
                        if (DEBUG_MODE) {
                            console.log('ğŸ“· Image uploaded and processed');
                        }
                    } catch (error) {
                        console.error('Image processing error:', error);
                        alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        showLoading(false);
                    }
                };
                img.onerror = () => {
                    alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    showLoading(false);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // í°íŠ¸ ë¡œë”© ëŒ€ê¸° í•¨ìˆ˜
        function waitForFonts() {
            return new Promise((resolve) => {
                if (document.fonts && document.fonts.ready) {
                    document.fonts.ready.then(resolve);
                } else {
                    // í°íŠ¸ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° ì§§ì€ ì§€ì—°
                    setTimeout(resolve, 500);
                }
            });
        }

        // ì•ˆì •ì ì¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        async function downloadAsImage() {
            const resultDiv = document.getElementById('resultDiv');
            if (!window.html2canvas || !resultDiv) {
                alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading(true, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
            
            try {
                // í°íŠ¸ ë¡œë”© ì™„ë£Œ ëŒ€ê¸°
                await waitForFonts();
                
                // ë ˆì´ì•„ì›ƒ ì•ˆì •í™”ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 200));

                // ì•ˆì •ì ì´ë©´ì„œë„ ì¢‹ì€ í’ˆì§ˆì˜ ì„¤ì •
                const canvas = await window.html2canvas(resultDiv, {
                    backgroundColor: '#ffffff',
                    scale: 2.5, // ì ë‹¹í•œ ê³ í•´ìƒë„
                    useCORS: true,
                    allowTaint: false,
                    logging: false,
                    width: resultDiv.scrollWidth,
                    height: resultDiv.scrollHeight,
                    // ì•ˆì •ì„±ì„ ìœ„í•œ ì„¤ì •
                    foreignObjectRendering: false, // í˜¸í™˜ì„± ê°œì„ 
                    letterRendering: true, // í…ìŠ¤íŠ¸ í’ˆì§ˆ ê°œì„ 
                    // í°íŠ¸ ë Œë”ë§ ìµœì í™”
                    onclone: function(clonedDoc) {
                        const style = clonedDoc.createElement('style');
                        style.textContent = `
                            * {
                                font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', 'Apple SD Gothic Neo', sans-serif !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                word-break: keep-all !important;
                                line-height: 1.6 !important;
                            }
                        `;
                        clonedDoc.head.appendChild(style);
                    }
                });

                // íŒŒì¼ëª… ìƒì„±
                const sanitizedName = appState.studentName.replace(/[^\w\s-ê°€-í£]/gi, '') || 'ê°€ì¡±ë§ˆìŒíƒí—˜';
                const timestamp = new Date().toLocaleDateString('ko-KR').replace(/\./g, '-');
                
                const link = document.createElement('a');
                link.download = `${sanitizedName}_ê°€ì¡±ë§ˆìŒíƒí—˜ê²°ê³¼_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png', 0.95); // í’ˆì§ˆê³¼ íŒŒì¼í¬ê¸° ê· í˜•
                link.click();

                // ë©”ëª¨ë¦¬ ì •ë¦¬
                canvas.width = canvas.height = 0;
                
                if (DEBUG_MODE) {
                    console.log('âœ… Image downloaded successfully');
                }

                // ì„±ê³µ ë©”ì‹œì§€
                setTimeout(() => {
                    alert('ğŸ‰ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‹¤ìš´ë¡œë“œ í´ë”ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.');
                }, 500);

            } catch (error) {
                console.error('Download error:', error);
                
                // ê°„ë‹¨í•œ ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ì¬ì‹œë„
                try {
                    showLoading(true, 'ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ì‹œë„ ì¤‘...');
                    
                    const canvas = await window.html2canvas(resultDiv, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        logging: false
                    });

                    const sanitizedName = appState.studentName.replace(/[^\w\s-ê°€-í£]/gi, '') || 'ê°€ì¡±ë§ˆìŒíƒí—˜';
                    const timestamp = new Date().toLocaleDateString('ko-KR').replace(/\./g, '-');
                    
                    const link = document.createElement('a');
                    link.download = `${sanitizedName}_ê²°ê³¼_${timestamp}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    canvas.width = canvas.height = 0;
                    
                    setTimeout(() => {
                        alert('âœ… ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }, 300);

                } catch (fallbackError) {
                    console.error('Fallback download error:', fallbackError);
                    alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në‹¤ìŒ ë°©ë²•ì„ ì‹œë„í•´ë³´ì„¸ìš”:\nâ€¢ ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„\nâ€¢ ì¸ì‡„ ê¸°ëŠ¥ ì´ìš©\nâ€¢ ìŠ¤í¬ë¦°ìƒ· ë„êµ¬ ì‚¬ìš©');
                }
            } finally {
                showLoading(false);
            }
        }

        // ê²°ê³¼ ê³µìœ 
        function shareResult() {
            const text = `${appState.studentName}ë‹˜ì˜ ê°€ì¡± ë§ˆìŒ íƒí—˜ ê²°ê³¼\n\n` +
                `ğŸ‘€ ë³´ì¸ ê²ƒ: ${appState.seeAnswers}\n` +
                `ğŸ¤” ìƒê°í•œ ê²ƒ: ${appState.thinkAnswers}\n` +
                `â“ ê¶ê¸ˆí•œ ê²ƒ: ${appState.wonderAnswers}\n` +
                `ğŸ’ ëŠë‚€ ê°ì •: ${appState.emotions.map(e => e.emoji + e.name).join(', ')}\n` +
                `ğŸ‘¥ ë‚˜ì˜ ì´ì•¼ê¸°: ${appState.myStory}\n` +
                `â­ ì˜¤ëŠ˜ì˜ ê¹¨ë‹¬ìŒ: ${appState.reflection}`;

            if (navigator.share) {
                navigator.share({
                    title: 'ìš°ë¦¬ ê°€ì¡± ë§ˆìŒ íƒí—˜ëŒ€',
                    text: text
                }).catch(err => {
                    console.log('Share canceled:', err);
                });
            } else if (navigator.clipboard) {
                // í´ë¦½ë³´ë“œì— ë³µì‚¬
                navigator.clipboard.writeText(text).then(() => {
                    alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(() => {
                    alert('ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                });
            } else {
                alert('ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        function nextStep() {
            if (appState.currentStep < steps.length - 1 && canProceed()) {
                appState.currentStep++;
                updateUI();
                renderStep();
                autoSave();
                
                if (DEBUG_MODE) {
                    console.log(`â¡ï¸ Moved to step ${appState.currentStep}`);
                }
            }
        }

        function prevStep() {
            if (appState.currentStep > 0) {
                appState.currentStep--;
                updateUI();
                renderStep();
                
                if (DEBUG_MODE) {
                    console.log(`â¬…ï¸ Moved to step ${appState.currentStep}`);
                }
            }
        }

        // ì´ˆê¸°í™”
        function resetAll() {
            if (confirm('ì •ë§ë¡œ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ì–´ìš”? ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                Object.assign(appState, {
                    currentStep: 0,
                    studentName: '',
                    familyImage: null,
                    seeAnswers: '',
                    thinkAnswers: '',
                    wonderAnswers: '',
                    emotions: [],
                    myStory: '',
                    reflection: '',
                    lastSaved: null
                });
                localStorage.removeItem(STORAGE_KEY);
                updateUI();
                renderStep();
                
                if (DEBUG_MODE) {
                    console.log('ğŸ”„ Application reset');
                }
            }
        }

        // í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
        window.addEventListener('beforeunload', (e) => {
            if (appState.studentName && appState.currentStep > 0 && appState.currentStep < steps.length - 1) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>